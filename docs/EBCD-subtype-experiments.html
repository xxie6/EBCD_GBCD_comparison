<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Annie Xie" />

<meta name="date" content="2024-05-01" />

<title>EBCD-subtype-experiments</title>

<script src="site_libs/header-attrs-2.26/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/main/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">EBCD_GBCD_comparison</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/xxie6/EBCD_GBCD_comparison">
    <span class="fab fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">EBCD-subtype-experiments</h1>
<h4 class="author">Annie Xie</h4>
<h4 class="date">2024-05-01</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span>
workflowr <span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2024-05-20
</p>
<p>
<strong>Checks:</strong> <span
class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7
<span class="glyphicon glyphicon-exclamation-sign text-danger"
aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>EBCD_GBCD_comparison/</code>
<span class="glyphicon glyphicon-question-sign" aria-hidden="true"
title="This is the local directory in which the code in this file was executed.">
</span>
</p>
<p>
This reproducible <a href="https://rmarkdown.rstudio.com">R Markdown</a>
analysis was created with <a
  href="https://github.com/workflowr/workflowr">workflowr</a> (version
1.7.1). The <em>Checks</em> tab describes the reproducibility checks
that were applied when the results were created. The <em>Past
versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date
</a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git
repository, you know the exact version of the code that produced these
results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the
global environment can affect the analysis in your R Markdown file in
unknown ways. For reproduciblity it’s best to always run the code in an
empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20240229code">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Seed:</strong>
<code>set.seed(20240229)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20240229code"
class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20240229)</code> was run prior to running
the code in the R Markdown file. Setting a seed ensures that any results
that rely on randomness, e.g. subsampling or permutations, are
reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Session information:</strong>
recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded"
class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package
versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be
confident that you successfully produced the results during this
run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr
project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomxxie6EBCDGBCDcomparisontreedf3c2aab343cdde2c8d68075c28c6129f92a12b3targetblankdf3c2aaa">
<span class="glyphicon glyphicon-ok text-success"
aria-hidden="true"></span> <strong>Repository version:</strong>
<a href="https://github.com/xxie6/EBCD_GBCD_comparison/tree/df3c2aab343cdde2c8d68075c28c6129f92a12b3" target="_blank">df3c2aa</a>
</a>
</p>
</div>
<div
id="strongRepositoryversionstrongahrefhttpsgithubcomxxie6EBCDGBCDcomparisontreedf3c2aab343cdde2c8d68075c28c6129f92a12b3targetblankdf3c2aaa"
class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development
and connecting the code version to the results is critical for
reproducibility.
</p>
<p>
The results in this page were generated with repository version
<a href="https://github.com/xxie6/EBCD_GBCD_comparison/tree/df3c2aab343cdde2c8d68075c28c6129f92a12b3" target="_blank">df3c2aa</a>.
See the <em>Past versions</em> tab to see a history of the changes made
to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for
the analysis have been committed to Git prior to generating the results
(you can use <code>wflow_publish</code> or
<code>wflow_git_commit</code>). workflowr only checks the R Markdown
file, but you know if there are other scripts or data files that it
depends on. Below is the status of the Git repository when the results
were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    .Rhistory
    Ignored:    code/.DS_Store
    Ignored:    data/.DS_Store

Untracked files:
    Untracked:  analysis/EBCD-laplace-splitting.Rmd
    Untracked:  analysis/ridgeless-regression-comparison.Rmd

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not
included in this status report because it is ok for generated content to
have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were
made to the R Markdown
(<code>analysis/EBCD-subtype-experiments.Rmd</code>) and HTML
(<code>docs/EBCD-subtype-experiments.html</code>) files. If you’ve
configured a remote Git repository (see <code>?wflow_git_remote</code>),
click on the hyperlinks in the table below to view the files as they
were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/xxie6/EBCD_GBCD_comparison/blob/df3c2aab343cdde2c8d68075c28c6129f92a12b3/analysis/EBCD-subtype-experiments.Rmd" target="_blank">df3c2aa</a>
</td>
<td>
Annie Xie
</td>
<td>
2024-05-20
</td>
<td>
wflow_publish("analysis/EBCD-subtype-experiments.Rmd")
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/xxie6/EBCD_GBCD_comparison/blob/845fd53af0adef7df634e4a7d47e6ceb3eed97ee/analysis/EBCD-subtype-experiments.Rmd" target="_blank">845fd53</a>
</td>
<td>
Annie Xie
</td>
<td>
2024-05-08
</td>
<td>
Add normal and subtype simulations
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/xxie6/EBCD_GBCD_comparison/845fd53af0adef7df634e4a7d47e6ceb3eed97ee/docs/EBCD-subtype-experiments.html" target="_blank">845fd53</a>
</td>
<td>
Annie Xie
</td>
<td>
2024-05-08
</td>
<td>
Add normal and subtype simulations
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>In this analysis, I run some experiments to explore when EBCD can
find subtype GEPs. The goal of these simulations is to find the simplest
setting in which EBCD does not recover all subtype factors.</p>
</div>
<div id="package-and-functions-for-analyses" class="section level1">
<h1>Package and Functions for Analyses</h1>
<pre class="r"><code>library(ggplot2)
library(cowplot)
library(RColorBrewer)
library(ggrepel)
library(pheatmap)
library(gridExtra)
#library(Seurat)
library(Matrix)
library(ebnm)
library(flashier)</code></pre>
<pre><code>Loading required package: magrittr</code></pre>
<pre class="r"><code>library(magrittr)
library(ashr)
library(irlba)
library(reshape2)

library(patchwork)</code></pre>
<pre><code>
Attaching package: &#39;patchwork&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:cowplot&#39;:

    align_plots</code></pre>
<pre class="r"><code>library(fastTopics)
#source(&quot;~/Documents/PhD 3/Research/EBCD/gbcd-workflow/code/fit_cov_ebnmf.R&quot;)</code></pre>
<pre class="r"><code>plot_heatmap &lt;- function(L, title = &quot;&quot;, colors_range = c(&quot;gray96&quot;, &quot;red&quot;)){
  ### define the color map
  cols &lt;- colorRampPalette(colors_range)(49)
  brks &lt;- seq(min(L), max(L), length=50)
  
  plt &lt;- pheatmap(L, show_rownames = FALSE, show_colnames = FALSE, cluster_rows = FALSE, cluster_cols = FALSE, color = cols, breaks = brks, main = title)
  return(plt)
}</code></pre>
<pre class="r"><code>source(&quot;~/Documents/PhD 3/Research/EBCD/ebcd_functions.R&quot;)</code></pre>
</div>
<div id="simulate-data-under-ebcd-model-normal-noise"
class="section level1">
<h1>Simulate data under EBCD model (normal noise)</h1>
<p>In this simulation, we simulate data from the EBCD model. The
loadings matrix, <span class="math inline">\(L\)</span>, is binary and
consists of three factors – one baseline factor loaded on all samples,
one subtype factor loaded on half of the samples (which can be thought
of as corresponding to subtype 1), and a second subtype factor loaded on
the other half of the samples (which can be thought of as corresponding
to subtype 2). The factor matrix, <span
class="math inline">\(F\)</span>, has a block structure and has been
rescaled such that <span class="math inline">\(F^{T}F = I\)</span>.
Normal noise is then added to the product <span class="math inline">\(L
F^{T}\)</span>. The standard deviation of the noise is chosen such that
the Gram matrix has a block structure corresponding to the subtype
effects.</p>
<div id="hypothesis" class="section level2">
<h2>Hypothesis</h2>
<p>Since the data is generated under the same assumptions of the EBCD
model with relatively little noise, I hypothesize that EBCD will be able
to recover both subtypes.</p>
</div>
<div id="analysis" class="section level2">
<h2>Analysis</h2>
<pre class="r"><code>generate_normal_data &lt;- function(noise_sd){
  ### simulate L
  LL &lt;- matrix(0, nrow=800, ncol=3)
  LL[,1] &lt;- 1
  LL[1:400, 2] &lt;- 1
  LL[401:800, 3] &lt;- 1
  
  ### simulate F
  FF &lt;- matrix(0, nrow=1800, ncol = 3)
  FF[1:600,1] &lt;- rnorm(600, mean = 0, sd = 1) 
  FF[601:1200,2] &lt;- rnorm(600, mean = 0, sd = 1) 
  FF[1201:1800,3] &lt;- rnorm(600, mean = 0, sd = 1) 
  FF &lt;- t(t(FF)/apply(FF,2, function(x){return(sqrt(sum(x^2)))}))
  ##FF &lt;- matrix(rnorm(3 * 2100, sd = 1), ncol = 3)
  
  ### generate normal noise
  E &lt;- matrix(rnorm(800*1800, mean = 0, sd = noise_sd), ncol = 1800)
  
  ### save the simulated data
  data &lt;- list(Y = LL %*% t(FF) + E, LL = LL, FF = FF)
  return(data)
}</code></pre>
<div id="single-analysis" class="section level3">
<h3>Single Analysis</h3>
<pre class="r"><code>set.seed(2052)
data_norm &lt;- generate_normal_data(0.01)</code></pre>
<pre class="r"><code>dim(data_norm$Y)</code></pre>
<pre><code>[1]  800 1800</code></pre>
<p>These are some visualizations of the simulated data. This is a
heatmap of the loadings matrix.</p>
<pre class="r"><code>plot_heatmap(data_norm$LL)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the factor matrix.</p>
<pre class="r"><code>plot_heatmap(data_norm$FF, colors_range = c(&#39;blue&#39;,&#39;red&#39;))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of <span class="math inline">\(F^{T}F\)</span>.
This is to check that it is orthogonal.</p>
<pre class="r"><code>plot_heatmap(t(data_norm$FF) %*% data_norm$FF)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>observed.vals &lt;- data_norm$Y %*% t(data_norm$Y)/ ncol(data_norm$Y)</code></pre>
<p>This is a heatmap of the Gram matrix.</p>
<pre class="r"><code>plot_heatmap(observed.vals)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We apply EBCD to the data with <code>Kmax = 10</code> and the
generalized binary prior over the loadings.</p>
<pre class="r"><code>set.seed(295)
fit.ebcd &lt;- ebcd(X = t(data_norm$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary)</code></pre>
<p>This is a plot of the scaled estimate of <span
class="math inline">\(L\)</span>. This estimate is scaled such that the
infinity norm for each column is 1, i.e. the maximum value for each
column is 1.</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd$EL)/apply(fit.ebcd$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot_heatmap(fit.ebcd$EL)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>transformed_Z &lt;- transform_ebcd_Z(t(data_norm$Y), fit.ebcd)</code></pre>
<p>This is a plot of the factor matrix.</p>
<pre class="r"><code>plot_heatmap(transformed_Z, colors_range = c(&#39;blue&#39;, &#39;red&#39;))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the positive part of the factor matrix.</p>
<pre class="r"><code>#heatmap of the positive part of the factor matrix
plot_heatmap(pmax(transformed_Z, 0))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the negative part of the factor matrix.</p>
<pre class="r"><code>#heatmap of the negative part of the factor matrix
plot_heatmap(pmin(transformed_Z, 0), colors_range = c(&#39;red&#39;,&#39;gray96&#39;))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals &lt;- fit.ebcd$EL %*% t(fit.ebcd$EL)</code></pre>
<p>This is a plot of <span class="math inline">\(LL^{T}\)</span>.</p>
<pre class="r"><code>plot_heatmap(ebcd.fitted.vals)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-21-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is the L2 norm of the difference between the observed values and
the fitted values.</p>
<pre class="r"><code>sum((observed.vals - ebcd.fitted.vals)^2)</code></pre>
<pre><code>[1] 4.608481e-05</code></pre>
<p>This is the L2 norm of the difference between the off-diagonal
entries of the observed values and fitted values.</p>
<pre class="r"><code>sum((observed.vals - ebcd.fitted.vals)^2) - sum((diag(observed.vals) - diag(ebcd.fitted.vals))^2)</code></pre>
<pre><code>[1] 3.842179e-05</code></pre>
<p>This is a plot of (a subset of) the off-diagonal entries of the
fitted values vs. observed values:</p>
<pre class="r"><code>set.seed(3952)
diag_idx &lt;- seq(1, prod(dim(observed.vals)), length.out = ncol(observed.vals))
off_diag_idx &lt;- setdiff(c(1:prod(dim(observed.vals))), diag_idx) 
samp.vals &lt;- sample(off_diag_idx, size = 100000)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals))[samp.vals], y = c(ebcd.fitted.vals)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-25-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the diagonal entries of the fitted values vs. the
diagonal entries of the observed values:</p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals)), y = diag(ebcd.fitted.vals))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-26-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the progression of the objective function</p>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(1:length(fit.ebcd$vec.obj)), y = fit.ebcd$vec.obj)) + geom_line()</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is the number of iterations that the backfit did before the
convergence criterion was satisfied:</p>
<pre class="r"><code>length(fit.ebcd$vec.obj)</code></pre>
<pre><code>[1] 895</code></pre>
<p>This is the value of the objective function that was attained:</p>
<pre class="r"><code>fit.ebcd$vec.obj[length(fit.ebcd$vec.obj)]</code></pre>
<pre><code>[1] 4595859</code></pre>
</div>
<div id="repeated-experiments" class="section level3">
<h3>Repeated Experiments</h3>
<p>In this section, we repeat the simulation workflow ten times,
generating ten different datasets and applying EBCD to each of them.
Then we calculate the proportion of times that EBCD is able to recover
each subtype factor.</p>
<p>This function computes numerous datasets for a given noise standard
deviation.</p>
<pre class="r"><code>generate_normal_datasets &lt;- function(noise_sd, num_datasets){
  dataset_list &lt;- list()
  for (i in 1:num_datasets){
    set.seed(i)
    dataset_list[[i]] &lt;- generate_normal_data(noise_sd)
  }
  return(dataset_list)
}</code></pre>
<p>This function determines whether the EBCD estimate recovers the
subtype factors by checking the correlation matrix between the EBCD
estimate and true loadings matrix.</p>
<pre class="r"><code>check_subtype_recovery &lt;- function(true.fit, ebcd.fit){
  corr_matrix &lt;- cor(ebcd.fit$EL, true.fit$L[,c(2:3)]) # need first two columns to be subtype
  max_corr &lt;- apply(corr_matrix, 2, max)
  return(as.numeric(max_corr &gt; 0.9))
}</code></pre>
<p>This function computes the proportion of times that EBCD recovers
each subtype factor.</p>
<pre class="r"><code>compute_subtype_recovery_prop &lt;- function(dataset_list, ebcdfit_list){
  recovery_matrix &lt;- matrix(rep(0, 2*length(dataset_list)), ncol = 2)
  for (i in 1:length(dataset_list)){
    recovery_matrix[i,] &lt;- check_subtype_recovery(dataset_list[[i]], ebcdfit_list[[i]])
  }
  return(colMeans(recovery_matrix))
}</code></pre>
<p>We repeat the experiment ten times and compute the proportion of time
EBCD recovers each subtype factor.</p>
<pre class="r"><code>multiple_simulation_workflow &lt;- function(noise_sd){
  dataset_list &lt;- generate_normal_datasets(noise_sd, 10)
  ebcdfit_list &lt;- lapply(dataset_list, function(x){return(ebcd(X = t(x$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary))})
  recovery_prop &lt;- compute_subtype_recovery_prop(dataset_list, ebcdfit_list)
  return(list(dataset_list = dataset_list, ebcdfit_list = ebcdfit_list, recovery_prop = recovery_prop))
}</code></pre>
<pre class="r"><code>results &lt;- multiple_simulation_workflow(0.01)</code></pre>
</div>
</div>
<div id="observations" class="section level2">
<h2>Observations</h2>
<p>In this setting, EBCD is generally able to find both subtypes when
given enough factors. When the simulation workflow is repeated ten
times, EBCD is able to find both subtypes every time. There are a few
experiments for which EBCD was able to recover both subtype factors
within the first 4-5 factors. However, there are other experiments for
which EBCD requires more factors to find both subtype factors.</p>
<p>It is interesting to me that in all the experiments, EBCD find many
factors that generally correspond to one subtype. I am unsure why it
doesn’t combine all of these factors into a single factor. Perhaps it’s
related to the factor matrix and, in particular, the orthogonality
constraint on the factor matrix.</p>
</div>
<div id="notes-after-meeting-with-matthew" class="section level2">
<h2>Notes after meeting with Matthew</h2>
<p>I discussed this set of results with Matthew. We tested running EBCD
with <code>Kmax = 3</code>, and found that it did not find the correct
loadings matrix. However, the estimate it did return still fit the
observed data well. We believe that EBCD converged to a different
loadings matrix that does not require the second subtype GEP. Here is a
concrete example:</p>
Let’s say our loadings matrix is
<span class="math display">\[\begin{bmatrix}
1 &amp; 1 &amp; 0\\
1 &amp; 0 &amp; 1\\
\end{bmatrix}\]</span>
Note that this loadings matrix has linearly dependent columns. Then
<span class="math inline">\(LL^{T}\)</span> would be
<span class="math display">\[\begin{bmatrix}
2 &amp; 1\\
1 &amp; 2\\
\begin{bmatrix}

It appears that the loading estimate that EBCD converges to is something
along the lines of
\begin{bmatrix}
2\\
1/\sqrt{2}
\end{bmatrix}
\begin{bmatrix}
2 &amp; 1/\sqrt{2}\\
\end{bmatrix}\]</span>
<ul>
<li><span class="math display">\[\begin{bmatrix}
0\\
\sqrt{3/4}
\end{bmatrix}
\begin{bmatrix}
0 &amp; \sqrt{3/4}\\
\end{bmatrix}\]</span></li>
</ul>
<p>(and perhaps it is breaking the second vector down even further). We
think that this is happening because we are using the generalized binary
prior which does not force the loading vectors to be binary; it just
encourages it. On the other hand, we hypothesize that GBCD is able to
recovery these binary loadings vectors because of its use of the laplace
prior and then splitting – this harkens back to ideas in Jason’s thesis
regarding the drift factorization and the divergence factorization.</p>
</div>
</div>
<div id="simulate-data-under-ebcd-model-vary-standard-deviation"
class="section level1">
<h1>Simulate data under EBCD model, vary standard deviation</h1>
<p>In the previous simulations, I chose the standard deviation of the
noise such that the Gram matrix had a visible block structure. A block
structure is expected due to the subtype effects modeled in the loadings
matrix. For larger standard deviations, the Gram matrix does not have an
apparent block structure. As the standard deviation decreases, the block
structure in the Gram matrix becomes more apparent and/or clearer.</p>
<p>In the previous setting, EBCD was able to recover both subtype
factors. However, I wanted to test how the standard deviation of the
noise affects this. In this section, I run the same analyses as above
for different standard deviation values, and assess how well EBCD
performs at each level.</p>
<div id="hypothesis-1" class="section level2">
<h2>Hypothesis</h2>
<p>Higher standard deviation values blur the block structure in the Gram
matrix. Therefore, I suspect that in these settings, EBCD will have a
more difficult time recovering both subtype factors. I am unsure if EBCD
will be able to recover one of the two subtype factors or if it will
struggle to find either of them. Given that the magnitude of effect for
both subtypes is the same, I can’t see why EBCD would be able to find
one and not the other.</p>
</div>
<div id="analysis-1" class="section level2">
<h2>Analysis</h2>
<div id="single-experiment" class="section level3">
<h3>Single experiment</h3>
<pre class="r"><code>set.seed(2052)
data_sd0.01 &lt;- generate_normal_data(0.01)
data_sd0.05 &lt;- generate_normal_data(0.05)
data_sd0.15 &lt;- generate_normal_data(0.15)
data_sd0.2 &lt;- generate_normal_data(0.2)
data_sd0.5 &lt;- generate_normal_data(0.5)</code></pre>
<pre class="r"><code>observed.vals_sd0.01 &lt;- data_sd0.01$Y %*% t(data_sd0.01$Y)/ ncol(data_sd0.01$Y)
observed.vals_sd0.05 &lt;- data_sd0.05$Y %*% t(data_sd0.05$Y)/ ncol(data_sd0.05$Y)
observed.vals_sd0.15 &lt;- data_sd0.15$Y %*% t(data_sd0.15$Y)/ ncol(data_sd0.15$Y)
observed.vals_sd0.2 &lt;- data_sd0.2$Y %*% t(data_sd0.2$Y)/ ncol(data_sd0.2$Y)
observed.vals_sd0.5 &lt;- data_sd0.5$Y %*% t(data_sd0.5$Y)/ ncol(data_sd0.5$Y)</code></pre>
<p>This is a heatmap of the Gram matrix for standard deviation =
0.01.</p>
<pre class="r"><code>plot_heatmap(observed.vals_sd0.01)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-40-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the Gram matrix for standard deviation =
0.05.</p>
<pre class="r"><code>plot_heatmap(observed.vals_sd0.05)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-41-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the Gram matrix for standard deviation =
0.15.</p>
<pre class="r"><code>plot_heatmap(observed.vals_sd0.15)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-42-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the Gram matrix for standard deviation =
0.2.</p>
<pre class="r"><code>plot_heatmap(observed.vals_sd0.2)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-43-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the Gram matrix for standard deviation =
0.5.</p>
<pre class="r"><code>plot_heatmap(observed.vals_sd0.5)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-44-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We apply EBCD with <code>Kmax = 10</code> and the generalized binary
prior over the loadings.</p>
<pre class="r"><code>set.seed(295)
fit.ebcd_sd0.01 &lt;- ebcd(X = t(data_sd0.01$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary)
fit.ebcd_sd0.05 &lt;- ebcd(X = t(data_sd0.05$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary)
fit.ebcd_sd0.15 &lt;- ebcd(X = t(data_sd0.15$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary)
fit.ebcd_sd0.2 &lt;- ebcd(X = t(data_sd0.2$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary)
fit.ebcd_sd0.5 &lt;- ebcd(X = t(data_sd0.5$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary)</code></pre>
<p>These are visualizations for standard deviation = 0.01:</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_sd0.01$EL)/apply(fit.ebcd_sd0.01$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-47-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals_sd0.01 &lt;- fit.ebcd_sd0.01$EL %*% t(fit.ebcd_sd0.01$EL)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_sd0.01))[samp.vals], y = c(ebcd.fitted.vals_sd0.01)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Subsample of Off Diangle entries for SD = 0.01&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-50-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_sd0.01)), y = diag(ebcd.fitted.vals_sd0.01))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Diagonal entries for SD = 0.01&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-51-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>These are visualizations for standard deviation = 0.05:</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_sd0.05$EL)/apply(fit.ebcd_sd0.05$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-52-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals_sd0.05 &lt;- fit.ebcd_sd0.05$EL %*% t(fit.ebcd_sd0.05$EL)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_sd0.05))[samp.vals], y = c(ebcd.fitted.vals_sd0.05)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Subsample of Off Diangle entries for SD = 0.05&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-55-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_sd0.05)), y = diag(ebcd.fitted.vals_sd0.05))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Diagonal entries for SD = 0.05&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-56-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>These are visualizations for standard deviation = 0.15:</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_sd0.15$EL)/apply(fit.ebcd_sd0.15$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-57-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals_sd0.15 &lt;- fit.ebcd_sd0.15$EL %*% t(fit.ebcd_sd0.15$EL)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_sd0.15))[samp.vals], y = c(ebcd.fitted.vals_sd0.15)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Subsample of Off Diangle entries for SD = 0.15&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-60-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_sd0.15)), y = diag(ebcd.fitted.vals_sd0.15))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Diagonal entries for SD = 0.15&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-61-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>These are visualizations for standard deviation = 0.2:</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_sd0.2$EL)/apply(fit.ebcd_sd0.2$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-62-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals_sd0.2 &lt;- fit.ebcd_sd0.2$EL %*% t(fit.ebcd_sd0.2$EL)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_sd0.2))[samp.vals], y = c(ebcd.fitted.vals_sd0.2)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Subsample of Off Diangle entries for SD = 0.2&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-65-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_sd0.2)), y = diag(ebcd.fitted.vals_sd0.2))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Diagonal entries for SD = 0.2&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-66-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>These are visualizations for standard deviation = 0.5:</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_sd0.5$EL)/apply(fit.ebcd_sd0.5$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-67-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals_sd0.5 &lt;- fit.ebcd_sd0.5$EL %*% t(fit.ebcd_sd0.5$EL)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_sd0.5))[samp.vals], y = c(ebcd.fitted.vals_sd0.5)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Subsample of Off Diangle entries for SD = 0.5&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-70-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_sd0.5)), y = diag(ebcd.fitted.vals_sd0.5))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Diagonal entries for SD = 0.5&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-71-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="repeated-experiments-1" class="section level3">
<h3>Repeated experiments</h3>
<p>In this section, we repeat the simulation workflow ten times,
generating ten different datasets for each standard deviation value and
applying EBCD to each. For each standard deviation value, we calculate
the proportion of times that EBCD is able to recover each subtype
factor.</p>
<pre class="r"><code>noise_sds &lt;- c(0.01,0.05,0.1,0.3,0.5)
recovery_prop_sds &lt;- matrix(rep(0, 2*length(noise_sds)), ncol = 2)
for (j in 1:length(noise_sds)){
  print(noise_sds[j])
  dataset_list &lt;- generate_normal_datasets(noise_sds[j], 10)
  ebcdfit_list &lt;- lapply(dataset_list, function(x){return(ebcd(X = t(x$Y), Kmax = 10, ebnm_fn = ebnm::ebnm_generalized_binary))})
  recovery_prop &lt;- compute_subtype_recovery_prop(dataset_list, ebcdfit_list)
  recovery_prop_sds[j,] &lt;- recovery_prop
}</code></pre>
</div>
</div>
<div id="observations-1" class="section level2">
<h2>Observations</h2>
<p>As predicted, as the standard deviation of the noise increases, the
recovery proportion of the subtype decreases. For small standard
deviation values, e.g. 0.01 or 0.05, EBCD is able to recover both
subtypes in all instances. For larger standard deviation values,
e.g. 0.5 or 1, EBCD is not able to recover both subtypes. Based off of
the single experiment analysis, it looks like EBCD might just recover a
bunch of shared GEPs and does not recover any GEPs that resemble subtype
effects. For middle-of-the-range standard deviation values, e.g. 0.15 or
0.2, EBCD is only able to find subtype GEPs a fraction of the time. From
the single experiment results, it looks like EBCD can find one of the
two subtype effects, but struggles to find the second subtype effect, or
the effect it finds is very sparse (too sparse to be considered an
accurate recovery of the effect). I will look into this in the next
section.</p>
</div>
<div id="closer-look-at-sd-0.15" class="section level2">
<h2>Closer look at SD = 0.15</h2>
<p>These are some visualizations of the simulated data. This is a
heatmap of the loadings matrix.</p>
<pre class="r"><code>plot_heatmap(data_sd0.15$LL)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-75-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of <span class="math inline">\(F^{T}F\)</span>.
This is to check that it is orthogonal.</p>
<pre class="r"><code>plot_heatmap(t(data_sd0.15$FF) %*% data_sd0.15$FF)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-76-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the Gram matrix.</p>
<pre class="r"><code>plot_heatmap(observed.vals_sd0.15)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-77-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the scaled estimate of <span
class="math inline">\(L\)</span>. This estimate is scaled such that the
infinity norm for each column is 1, i.e. the maximum value for each
column is 1.</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_sd0.15$EL)/apply(fit.ebcd_sd0.15$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-78-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>cor(fit.ebcd_sd0.15$EL, data_sd0.15$LL[,c(2,3)])</code></pre>
<pre><code>             [,1]        [,2]
 [1,] -0.54786434  0.54786434
 [2,]  0.97053810 -0.97053810
 [3,]  0.47264126 -0.47264126
 [4,]  0.42946825 -0.42946825
 [5,]  0.42040753 -0.42040753
 [6,] -0.63632538  0.63632538
 [7,] -0.03808361  0.03808361
 [8,] -0.05623888  0.05623888
 [9,] -0.07148017  0.07148017
[10,] -0.05692042  0.05692042</code></pre>
<pre class="r"><code>transformed_Z &lt;- transform_ebcd_Z(t(data_sd0.15$Y), fit.ebcd_sd0.15)</code></pre>
<p>This is a plot of the factor matrix.</p>
<pre class="r"><code>plot_heatmap(transformed_Z, colors_range = c(&#39;blue&#39;, &#39;red&#39;))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-81-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the positive part of the factor matrix.</p>
<pre class="r"><code>#heatmap of the positive part of the factor matrix
plot_heatmap(pmax(transformed_Z, 0))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-82-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the negative part of the factor matrix.</p>
<pre class="r"><code>#heatmap of the negative part of the factor matrix
plot_heatmap(pmin(transformed_Z, 0), colors_range = c(&#39;red&#39;,&#39;gray96&#39;))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-83-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals &lt;- fit.ebcd$EL %*% t(fit.ebcd$EL)</code></pre>
<p>This is a plot of <span class="math inline">\(LL^{T}\)</span>.</p>
<pre class="r"><code>plot_heatmap(ebcd.fitted.vals_sd0.15)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-85-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot_heatmap(observed.vals_sd0.15)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-86-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is the L2 norm of the difference between the observed values and
the fitted values.</p>
<pre class="r"><code>sum((observed.vals_sd0.15 - ebcd.fitted.vals_sd0.15)^2)</code></pre>
<pre><code>[1] 0.6006115</code></pre>
<p>This is the L2 norm of the difference between the off-diagonal
entries of the observed values and fitted values.</p>
<pre class="r"><code>sum((observed.vals_sd0.15 - ebcd.fitted.vals_sd0.15)^2) - sum((diag(observed.vals_sd0.15) - diag(ebcd.fitted.vals_sd0.15))^2)</code></pre>
<pre><code>[1] 0.2103414</code></pre>
<p>This is a plot of (a subset of) the off-diagonal entries of the
fitted values vs. observed values:</p>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_sd0.15))[samp.vals], y = c(ebcd.fitted.vals_sd0.15)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Subsample of Off Diangle entries for SD = 0.15&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-89-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the diagonal entries of the fitted values vs. the
diagonal entries of the observed values:</p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_sd0.15)), y = diag(ebcd.fitted.vals_sd0.15))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;) + labs(title=&quot;Diagonal entries for SD = 0.15&quot;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-90-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the progression of the objective function</p>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(1:length(fit.ebcd_sd0.15$vec.obj)), y = fit.ebcd_sd0.15$vec.obj)) + geom_line()</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-91-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is the number of iterations that the backfit did before the
convergence criterion was satisfied:</p>
<pre class="r"><code>length(fit.ebcd_sd0.15$vec.obj)</code></pre>
<pre><code>[1] 113</code></pre>
<p>This is the value of the objective function that was attained:</p>
<pre class="r"><code>fit.ebcd$vec.obj[length(fit.ebcd_sd0.15$vec.obj)]</code></pre>
<pre><code>[1] 4593881</code></pre>
<div id="observations-2" class="section level3">
<h3>Observations</h3>
<p>It looks like perhaps in this setting (where there are subtype
effects, but they are not super strong), EBCD can pick up on a subtype
effect, but the loadings themselves are sparse (too sparse to be
considered accurately “recovered”).</p>
<p>Also, in this setting, the EBCD result doesn’t have a particularly
good fit. This is what we would expect given that it cannot pick up on
the second subtype effect. There are situations in which EBCD doesn’t
pick up on a subtype effect, but it still manages to get a good fit,
which is confusing and counter-intuitive.</p>
</div>
</div>
</div>
<div id="data-with-patient-and-subtype-effects" class="section level1">
<h1>Data with patient and subtype effects</h1>
<p>In the previous simulations, we only consider a baseline factor and
two subtype factors. In this simulation, we add “patient effects”. Same
as before, we simulate data from the EBCD model. The loadings matrix,
<span class="math inline">\(L\)</span>, is binary and consists of seven
factors – one baseline factor loaded on all samples, two subtype factors
(each loaded on half of the samples) and four patient factors (each
loaded on one-fourth of the samples). The factor matrix, <span
class="math inline">\(F\)</span>, again has a block structure and has
been rescaled such that <span class="math inline">\(F^{T}F = I\)</span>.
Normal noise is then added to the product <span class="math inline">\(L
F^{T}\)</span>. The standard deviation of the noise is chosen such that
the Gram matrix has a block structure corresponding to the subtype
effects.</p>
<div id="hypothesis-2" class="section level2">
<h2>Hypothesis</h2>
<p>Similar to before, since the data is generated under the same
assumptions of the EBCD model with relatively little noise, I
hypothesize that EBCD will be able to recover both subtype effects and
all the patient effects.</p>
</div>
<div id="analysis-2" class="section level2">
<h2>Analysis</h2>
<pre class="r"><code>generate_normal_data_patient &lt;- function(noise_sd){
  ### simulate L
  LL &lt;- matrix(0, nrow=800, ncol=7)
  LL[,1] &lt;- 1
  LL[1:400, 2] &lt;- 1
  LL[401:800, 3] &lt;- 1
  LL[1:200,4] &lt;- 1
  LL[201:400, 5] &lt;- 1
  LL[401:600, 6] &lt;- 1
  LL[601:800, 7] &lt;- 1
  
  ### simulate F
  FF &lt;- matrix(0, nrow=2100, ncol = 7)
  FF[1:300,1] &lt;- rnorm(300, mean = 0, sd = 1) 
  FF[301:600,2] &lt;- rnorm(300, mean = 0, sd = 1) 
  FF[601:900,3] &lt;- rnorm(300, mean = 0, sd = 1) 
  FF[901:1200, 4] &lt;- rnorm(300, mean = 0, sd = 1) 
  FF[1201:1500, 5] &lt;- rnorm(300, mean = 0, sd = 1) 
  FF[1501:1800,6] &lt;- rnorm(300, mean = 0, sd = 1) 
  FF[1801:2100, 7] &lt;- rnorm(300, mean = 0, sd = 1) 
  FF &lt;- t(t(FF)/apply(FF,2, function(x){return(sqrt(sum(x^2)))}))
  ##FF &lt;- matrix(rnorm(3 * 2100, sd = 1), ncol = 3)
  
  ### generate normal noise
  E &lt;- matrix(rnorm(800*2100, mean = 0, sd = noise_sd), ncol = 2100)
  
  ### save the simulated data
  data &lt;- list(Y = LL %*% t(FF) + E, LL = LL, FF = FF)
  return(data)
}</code></pre>
<div id="single-analysis-1" class="section level3">
<h3>Single Analysis</h3>
<pre class="r"><code>set.seed(2052)
data_norm_patient &lt;- generate_normal_data_patient(0.01)</code></pre>
<pre class="r"><code>dim(data_norm_patient$Y)</code></pre>
<pre><code>[1]  800 2100</code></pre>
<pre class="r"><code>plot_heatmap(data_norm_patient$LL)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-97-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot_heatmap(t(data_norm_patient$FF) %*% data_norm_patient$FF)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-98-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>observed.vals_patient &lt;- data_norm_patient$Y %*% t(data_norm_patient$Y)/ ncol(data_norm_patient$Y)</code></pre>
<pre class="r"><code>plot_heatmap(observed.vals_patient)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-100-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>set.seed(295)
fit.ebcd_patient &lt;- ebcd(X = t(data_norm_patient$Y), Kmax = 15, ebnm_fn = ebnm::ebnm_generalized_binary)</code></pre>
<p>This is a plot of the scaled estimate of <span
class="math inline">\(L\)</span>. This estimate is scaled such that the
infinity norm for each column is 1, i.e. the maximum value for each
column is 1.</p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_patient$EL)/apply(fit.ebcd_patient$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-103-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the factor matrix.</p>
<pre class="r"><code>transformed_Z_patient &lt;- transform_ebcd_Z(t(data_norm_patient$Y), fit.ebcd_patient)</code></pre>
<pre class="r"><code>plot_heatmap(transformed_Z_patient, colors_range = c(&#39;blue&#39;, &#39;red&#39;))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-105-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the positive part of the factor matrix.</p>
<pre class="r"><code>#heatmap of the positive part of the factor matrix
plot_heatmap(pmax(transformed_Z_patient, 0))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-106-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a heatmap of the negative part of the factor matrix.</p>
<pre class="r"><code>#heatmap of the negative part of the factor matrix
plot_heatmap(pmin(transformed_Z_patient, 0), colors_range = c(&#39;red&#39;,&#39;gray96&#39;))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-107-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ebcd.fitted.vals_patient &lt;- fit.ebcd_patient$EL %*% t(fit.ebcd_patient$EL)</code></pre>
<p>This is a plot of <span class="math inline">\(LL^{T}\)</span>.</p>
<pre class="r"><code>plot_heatmap(ebcd.fitted.vals_patient)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-109-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the Gram matrix.</p>
<pre class="r"><code>plot_heatmap(observed.vals_patient)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-110-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>sum((observed.vals_patient - ebcd.fitted.vals_patient)^2)</code></pre>
<pre><code>[1] 7.000991e-05</code></pre>
<pre class="r"><code>sum((observed.vals_patient - ebcd.fitted.vals_patient)^2) - sum((diag(observed.vals_patient) - diag(ebcd.fitted.vals_patient))^2)</code></pre>
<pre><code>[1] 6.247311e-05</code></pre>
<p>This is a plot of (a subset of) the fitted values vs. observed
values:</p>
<pre class="r"><code>set.seed(3952)
diag_idx &lt;- seq(1, prod(dim(observed.vals_patient)), length.out = ncol(observed.vals_patient))
off_diag_idx &lt;- setdiff(c(1:prod(dim(observed.vals_patient))), diag_idx) 
samp.vals &lt;- sample(off_diag_idx, size = 100000)</code></pre>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_patient))[samp.vals], y = c(ebcd.fitted.vals_patient)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-114-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the diagonal entries of the fitted values vs. the
diagonal entries of the observed values:</p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_patient)), y = diag(ebcd.fitted.vals_patient))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-115-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is a plot of the progression of the objective function</p>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(1:length(fit.ebcd_patient$vec.obj)), y = fit.ebcd_patient$vec.obj)) + geom_line()</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-116-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>This is the number of iterations that the backfit did before the
convergence criterion was satisfied:</p>
<pre class="r"><code>length(fit.ebcd_patient$vec.obj)</code></pre>
<pre><code>[1] 213</code></pre>
<p>This is the value of the objective function that was attained:</p>
<pre class="r"><code>fit.ebcd_patient$vec.obj[length(fit.ebcd_patient$vec.obj)]</code></pre>
<pre><code>[1] 5365536</code></pre>
</div>
<div id="repeated-experiments-2" class="section level3">
<h3>Repeated Experiments</h3>
<p>In this section, we repeat the simulation workflow ten times,
generating ten different datasets and applying EBCD to each of them.
Then we calculate the proportion of times that EBCD is able to recover
each subtype factor.</p>
<p>This function computes numerous datasets for a given noise standard
deviation.</p>
<pre class="r"><code>generate_normal_patient_datasets &lt;- function(noise_sd, num_datasets){
  dataset_list &lt;- list()
  for (i in 1:num_datasets){
    set.seed(i)
    dataset_list[[i]] &lt;- generate_normal_data_patient(noise_sd)
  }
  return(dataset_list)
}</code></pre>
<p>We repeat the experiment ten times and compute the proportion of time
EBCD recovers each subtype factor.</p>
<pre class="r"><code>multiple_patient_simulation_workflow &lt;- function(noise_sd){
  dataset_list &lt;- generate_normal_patient_datasets(noise_sd, 10)
  ebcdfit_list &lt;- lapply(dataset_list, function(x){return(ebcd(X = t(x$Y), Kmax = 15, ebnm_fn = ebnm::ebnm_generalized_binary))})
  recovery_prop &lt;- compute_subtype_recovery_prop(dataset_list, ebcdfit_list)
  return(list(dataset_list = dataset_list, ebcdfit_list = ebcdfit_list, recovery_prop = recovery_prop))
}</code></pre>
<pre class="r"><code>results_patient &lt;- multiple_patient_simulation_workflow(0.01)</code></pre>
</div>
</div>
<div id="observations-3" class="section level2">
<h2>Observations</h2>
<p>In this setting, EBCD was able to recover both subtype GEPs. In
addition, it looks like EBCD was also able to recover all of the patient
effects in separate GEPs. When I repeated the experiment with ten
simulated datasets, EBCD was able to recover both subtypes in every
dataset. The EBCD estimate for the Gram matrix, <span
class="math inline">\(LL^{T}\)</span> does a good job at fitting the
data. In the fitted values vs. observed values plot, we see three groups
of points along the <code>y=x</code> line. I think the three groups
correspond to samples that do not share subtype or patient, samples that
share subtype but not patient, and samples that share patient (and thus
also subtype).</p>
</div>
</div>
<div id="data-with-patient-and-subtype-effects-varying-noise-sd"
class="section level1">
<h1>Data with patient and subtype effects, varying noise SD</h1>
<p>Similar to the subtype-only simulations, I chose the standard
deviation of the noise such that the Gram matrix had a visible block
structure. Again, I wanted to test how the standard deviation of the
noise affects the performance of EBCD. In this section, I run the same
analyses as above for different standard deviation values, and assess
how well EBCD performs at each level.</p>
<div id="hypothesis-3" class="section level2">
<h2>Hypothesis</h2>
<p>Higher standard deviation values blur the block structure in the Gram
matrix. Therefore, I suspect that in these settings, EBCD will have a
more difficult time recovering all of the subtype and patient
effects.</p>
</div>
<div id="analysis-3" class="section level2">
<h2>Analysis</h2>
<div id="single-analysis-2" class="section level3">
<h3>Single Analysis</h3>
<pre class="r"><code>set.seed(2052)
data_norm_patient_sd0.1 &lt;- generate_normal_data_patient(0.1)
data_norm_patient_sd0.2 &lt;- generate_normal_data_patient(0.2)
data_norm_patient_sd0.5 &lt;- generate_normal_data_patient(0.5)</code></pre>
<pre class="r"><code>observed.vals_patient_sd0.1 &lt;- data_norm_patient_sd0.1$Y %*% t(data_norm_patient_sd0.1$Y)/ ncol(data_norm_patient_sd0.1$Y)
observed.vals_patient_sd0.2 &lt;- data_norm_patient_sd0.2$Y %*% t(data_norm_patient_sd0.2$Y)/ ncol(data_norm_patient_sd0.2$Y)
observed.vals_patient_sd0.5 &lt;- data_norm_patient_sd0.5$Y %*% t(data_norm_patient_sd0.5$Y)/ ncol(data_norm_patient_sd0.5$Y)</code></pre>
<pre class="r"><code>set.seed(295)
fit.ebcd_patient_sd0.1 &lt;- ebcd(X = t(data_norm_patient_sd0.1$Y), Kmax = 15, ebnm_fn = ebnm::ebnm_generalized_binary)
fit.ebcd_patient_sd0.2 &lt;- ebcd(X = t(data_norm_patient_sd0.2$Y), Kmax = 15, ebnm_fn = ebnm::ebnm_generalized_binary)
fit.ebcd_patient_sd0.5 &lt;- ebcd(X = t(data_norm_patient_sd0.5$Y), Kmax = 15, ebnm_fn = ebnm::ebnm_generalized_binary)</code></pre>
<p>These are the visualizations and analyses for standard deviation =
0.1:</p>
<pre class="r"><code>plot_heatmap(observed.vals_patient_sd0.1)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-129-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_patient_sd0.1$EL)/apply(fit.ebcd_patient_sd0.1$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-130-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>cor(fit.ebcd_patient_sd0.1$EL, data_norm_patient_sd0.1$LL[,c(-1)])</code></pre>
<pre><code>              [,1]         [,2]         [,3]         [,4]         [,5]
 [1,] -0.394295105  0.394295105 -0.239482210 -0.215810560  0.209366590
 [2,]  0.956825164 -0.956825164  0.537975779  0.566870754 -0.548736279
 [3,] -0.570329499  0.570329499 -0.325638224 -0.332921555  0.991475481
 [4,]  0.573402542 -0.573402542  0.993162401 -0.331054178 -0.331053974
 [5,]  0.568689907 -0.568689907 -0.318739053  0.975405595 -0.328333297
 [6,]  0.746416888 -0.746416888  0.331677955  0.530210028 -0.427728000
 [7,]  0.669482826 -0.669482826  0.377095152  0.395957028 -0.399188093
 [8,] -0.573053055  0.573053055 -0.326589756 -0.335114915 -0.318956355
 [9,]  0.740874450 -0.740874450  0.385640038  0.469848088 -0.431057078
[10,] -0.781892185  0.781892185 -0.454412816 -0.448438511  0.241343697
[11,] -0.731835508  0.731835508 -0.422575471 -0.422475384  0.280076913
[12,] -0.055108223  0.055108223 -0.041992798 -0.021640696  0.002799782
[13,] -0.005594733  0.005594733  0.002167507 -0.008627748  0.009475405
[14,]  0.197673937 -0.197673937  0.094988813  0.133265388 -0.083523585
[15,]  0.018819326 -0.018819326 -0.010413510  0.032144196 -0.031521350
              [,6]
 [1,]  0.245926180
 [2,] -0.556110253
 [3,] -0.332915702
 [4,] -0.331054249
 [5,] -0.328333245
 [6,] -0.434159983
 [7,] -0.373864087
 [8,]  0.980661026
 [9,] -0.424431048
[10,]  0.661507630
[11,]  0.564973943
[12,]  0.060833712
[13,] -0.003015164
[14,] -0.144730616
[15,]  0.009790665</code></pre>
<pre class="r"><code>ebcd.fitted.vals_patient_sd0.1 &lt;- fit.ebcd_patient_sd0.1$EL %*% t(fit.ebcd_patient_sd0.1$EL)</code></pre>
<pre class="r"><code>plot_heatmap(ebcd.fitted.vals_patient_sd0.1)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-133-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_patient_sd0.1))[samp.vals], y = c(ebcd.fitted.vals_patient_sd0.1)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-134-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_patient_sd0.1)), y = diag(ebcd.fitted.vals_patient_sd0.1))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-135-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>These are the visualizations and analyses for standard deviation =
0.2:</p>
<pre class="r"><code>plot_heatmap(observed.vals_patient_sd0.2)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-136-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_patient_sd0.2$EL)/apply(fit.ebcd_patient_sd0.2$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-137-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>cor(fit.ebcd_patient_sd0.2$EL, data_norm_patient_sd0.2$LL[,c(-1)])</code></pre>
<pre><code>             [,1]        [,2]         [,3]         [,4]         [,5]
 [1,]  0.28424239 -0.28424239  0.099457496  0.228757344 -0.300907561
 [2,] -0.89219058  0.89219058 -0.507006267 -0.523206681  0.411820939
 [3,]  0.54297475 -0.54297475  0.949757055 -0.322783817 -0.316594864
 [4,] -0.52245888  0.52245888 -0.276815996 -0.326467557  0.923593709
 [5,] -0.35934868  0.35934868 -0.178282734 -0.236657375 -0.138556437
 [6,]  0.51789116 -0.51789116 -0.100132884  0.698142086 -0.273375675
 [7,]  0.08649082 -0.08649082  0.033675457  0.066195540  0.025655066
 [8,]  0.03783605 -0.03783605 -0.047955234  0.091644540  0.005206785
 [9,]  0.01957553 -0.01957553  0.021456055  0.001147825 -0.052261753
[10,] -0.05472038  0.05472038 -0.077232072  0.014046422  0.067313205
[11,]  0.03595669 -0.03595669 -0.011046212  0.052565423 -0.008111779
[12,] -0.06417813  0.06417813 -0.016594112 -0.057512406  0.061530266
[13,] -0.04004153  0.04004153  0.015987823 -0.062223797  0.023741712
[14,]  0.05104631 -0.05104631 -0.004135394  0.063078594  0.011616938
[15,]  0.04456596 -0.04456596 -0.033944811  0.085405148 -0.005062602
              [,6]
 [1,] -0.027307279
 [2,]  0.618392009
 [3,] -0.310378375
 [4,] -0.320310157
 [5,]  0.553496546
 [6,] -0.324633527
 [7,] -0.125526064
 [8,] -0.048896092
 [9,]  0.029657873
[10,] -0.004127555
[11,] -0.033407433
[12,]  0.012576252
[13,]  0.022494261
[14,] -0.070560138
[15,] -0.046397735</code></pre>
<pre class="r"><code>ebcd.fitted.vals_patient_sd0.2 &lt;- fit.ebcd_patient_sd0.2$EL %*% t(fit.ebcd_patient_sd0.2$EL)</code></pre>
<pre class="r"><code>plot_heatmap(ebcd.fitted.vals_patient_sd0.2)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-140-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_patient_sd0.2))[samp.vals], y = c(ebcd.fitted.vals_patient_sd0.2)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-141-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_patient_sd0.2)), y = diag(ebcd.fitted.vals_patient_sd0.2))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-142-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>These are the visualizations and analyses for standard deviation =
0.5:</p>
<pre class="r"><code>plot_heatmap(observed.vals_patient_sd0.5)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-143-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>plot_heatmap(t(t(fit.ebcd_patient_sd0.5$EL)/apply(fit.ebcd_patient_sd0.5$EL,2, max)))</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-144-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>cor(fit.ebcd_patient_sd0.5$EL, data_norm_patient_sd0.5$LL[,c(-1)])</code></pre>
<pre><code>              [,1]         [,2]         [,3]          [,4]         [,5]
 [1,]  0.045275432 -0.045275432  0.066009107 -0.0137295412 -0.007205106
 [2,] -0.501857309  0.501857309 -0.282592708 -0.2969021971  0.301328550
 [3,]  0.059501195 -0.059501195  0.060090562  0.0086154998  0.040979275
 [4,]  0.034659855 -0.034659855  0.046475537 -0.0064537838 -0.018730635
 [5,]  0.003166946 -0.003166946 -0.105910891  0.1095677651 -0.019291777
 [6,]  0.016418783 -0.016418783 -0.024732238  0.0436910160 -0.071326155
 [7,] -0.048194157  0.048194157 -0.076438011  0.0207881916  0.026317476
 [8,] -0.039269885  0.039269885 -0.002594753 -0.0427502041  0.009462949
 [9,] -0.205513531  0.205513531 -0.098134611 -0.1391719735  0.148668890
[10,]  0.108878878 -0.108878878 -0.056925241  0.1826477409 -0.038534787
[11,]  0.085207909 -0.085207909  0.097684660  0.0007049583 -0.087726920
[12,]  0.168296602 -0.168296602  0.105347844  0.0889843328 -0.085497058
[13,]  0.099490183 -0.099490183  0.053958804  0.0609225635 -0.108800642
[14,]  0.005766054 -0.005766054 -0.046434139  0.0530922047 -0.043677506
[15,]  0.145145321 -0.145145321  0.042609782  0.1249895978 -0.040894965
              [,6]
 [1,] -0.045074460
 [2,]  0.278166355
 [3,] -0.109685338
 [4,] -0.021291118
 [5,]  0.015634903
 [6,]  0.052367377
 [7,]  0.029332343
 [8,]  0.035882008
 [9,]  0.088637695
[10,] -0.087187713
[11,] -0.010662698
[12,] -0.108835120
[13,] -0.006080726
[14,]  0.037019441
[15,] -0.126704415</code></pre>
<pre class="r"><code>ebcd.fitted.vals_patient_sd0.5 &lt;- fit.ebcd_patient_sd0.5$EL %*% t(fit.ebcd_patient_sd0.5$EL)</code></pre>
<pre class="r"><code>plot_heatmap(ebcd.fitted.vals_patient_sd0.5)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-147-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = c(as.matrix(observed.vals_patient_sd0.5))[samp.vals], y = c(ebcd.fitted.vals_patient_sd0.5)[samp.vals])) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-148-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data = NULL, aes(x = diag(as.matrix(observed.vals_patient_sd0.5)), y = diag(ebcd.fitted.vals_patient_sd0.5))) + geom_point() + xlab(&#39;Observed Values&#39;) + ylab(&#39;Fitted Values&#39;) + geom_abline(slope = 1, intercept = 0, color = &#39;red&#39;)</code></pre>
<p><img src="figure/EBCD-subtype-experiments.Rmd/unnamed-chunk-149-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="observations-4" class="section level2">
<h2>Observations</h2>
<p>As expected, as the standard deviation increased, EBCD’s ability to
recover the subtype and patient effects decreased. For the largest
tested value, 0.5, EBCD can only recover one of the subtypes, and even
then, the loadings are very sparse and don’t fully capture the subtype
effect. For the middle value tested, 0.2, EBCD was able to recover one
of the subtype GEPs, but not both. It was able to recover effects that
resemble the patient effects, but it’s not a perfect recovery. For the
lowest value tested, 0.1, EBCD was able to recover one subtype and all
the patient effects well. It was also able to recover something that
resembles the second subtype, but it is not a perfect recovery due to
sparsity in the loadings.</p>
<p>One observation is that all of the estimates have additional sparse
shared GEPs. I’m not exactly sure why EBCD keeps these additional GEPs.
Maybe EBCD is overfitting a little bit to the noise?</p>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.3.2 (2023-10-31)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Sonoma 14.4.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] fastTopics_0.6-142 patchwork_1.2.0    reshape2_1.4.4     irlba_2.3.5.1     
 [5] ashr_2.2-63        flashier_1.0.7     magrittr_2.0.3     ebnm_1.1-2        
 [9] Matrix_1.6-5       gridExtra_2.3      pheatmap_1.0.12    ggrepel_0.9.5     
[13] RColorBrewer_1.1-3 cowplot_1.1.3      ggplot2_3.5.1      workflowr_1.7.1   

loaded via a namespace (and not attached):
 [1] pbapply_1.7-2      rlang_1.1.3        git2r_0.33.0       horseshoe_0.2.0   
 [5] compiler_4.3.2     getPass_0.2-4      callr_3.7.6        vctrs_0.6.5       
 [9] quantreg_5.97      quadprog_1.5-8     stringr_1.5.1      pkgconfig_2.0.3   
[13] crayon_1.5.2       fastmap_1.1.1      mcmc_0.9-8         labeling_0.4.3    
[17] utf8_1.2.4         promises_1.3.0     rmarkdown_2.26     ps_1.7.6          
[21] MatrixModels_0.5-3 purrr_1.0.2        xfun_0.43          cachem_1.0.8      
[25] trust_0.1-8        jsonlite_1.8.8     progress_1.2.3     highr_0.10        
[29] later_1.3.2        parallel_4.3.2     prettyunits_1.2.0  R6_2.5.1          
[33] bslib_0.7.0        stringi_1.8.3      SQUAREM_2021.1     jquerylib_0.1.4   
[37] Rcpp_1.0.12        knitr_1.45         httpuv_1.6.15      splines_4.3.2     
[41] tidyselect_1.2.1   rstudioapi_0.16.0  yaml_2.3.8         processx_3.8.4    
[45] lattice_0.22-6     tibble_3.2.1       plyr_1.8.9         withr_3.0.0       
[49] coda_0.19-4.1      evaluate_0.23      Rtsne_0.17         survival_3.6-4    
[53] RcppParallel_5.1.7 pillar_1.9.0       whisker_0.4.1      plotly_4.10.4     
[57] softImpute_1.4-1   generics_0.1.3     rprojroot_2.0.4    invgamma_1.1      
[61] truncnorm_1.0-9    hms_1.1.3          munsell_0.5.1      scales_1.3.0      
[65] glue_1.7.0         lazyeval_0.2.2     tools_4.3.2        data.table_1.15.4 
[69] SparseM_1.81       fs_1.6.4           grid_4.3.2         tidyr_1.3.1       
[73] MCMCpack_1.7-0     colorspace_2.1-0   deconvolveR_1.2-1  cli_3.6.2         
[77] fansi_1.0.6        mixsqp_0.3-54      viridisLite_0.4.2  dplyr_1.1.4       
[81] uwot_0.1.16        gtable_0.3.5       sass_0.4.9         digest_0.6.35     
[85] farver_2.1.1       htmlwidgets_1.6.4  htmltools_0.5.8.1  lifecycle_1.0.4   
[89] httr_1.4.7         MASS_7.3-60.0.1   </code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
https://docs.mathjax.org/en/latest/web/configuration.html. This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
